<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WoW LFG Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #10131a; }
        .card { border: 1px solid rgba(255, 255, 255, 0.08); }
        .section-title { font-size: 0.95rem; letter-spacing: 0.01em; }
        .small-muted { color: var(--bs-secondary-color); font-size: 0.875rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">WoW LFG Admin Dashboard</span>
            <div class="d-flex align-items-center gap-2">
                <span class="badge text-bg-secondary">Polling: 10s</span>
                <button id="refreshBtn" type="button" class="btn btn-primary btn-sm">Refresh</button>
            </div>
        </div>
    </nav>

    <main class="container-fluid py-3">
        <div class="row g-3">
            <div class="col-12 col-xl-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="section-title">Queue Status</span>
                        <span id="queueTotal" class="badge text-bg-info">...</span>
                    </div>
                    <div id="queueContent" class="card-body small-muted">Loading...</div>
                </div>
            </div>

            <div class="col-12 col-xl-6">
                <div class="card h-100">
                    <div class="card-header">
                        <span class="section-title">Active Groups Forming</span>
                    </div>
                    <div id="groupsContent" class="card-body small-muted">Loading...</div>
                </div>
            </div>

            <div class="col-12 col-xl-6">
                <div class="card h-100">
                    <div class="card-header">
                        <span class="section-title">Weekly Leaderboard</span>
                    </div>
                    <div id="leaderboardContent" class="card-body small-muted">Loading...</div>
                </div>
            </div>

            <div class="col-12 col-xl-6">
                <div class="card h-100">
                    <div class="card-header">
                        <span class="section-title">Completed Keys (Weekly)</span>
                    </div>
                    <div id="completedContent" class="card-body small-muted">Loading...</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function escapeHtml(value) {
            return String(value ?? "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;");
        }

        async function getJson(path) {
            const response = await fetch(path, { credentials: "same-origin" });
            if (!response.ok) {
                throw new Error("HTTP " + response.status);
            }
            return response.json();
        }

        function badgeForRole(role) {
            if (role === "tank") return '<span class="badge text-bg-primary">tank</span>';
            if (role === "healer") return '<span class="badge text-bg-success">healer</span>';
            if (role === "dps") return '<span class="badge text-bg-warning">dps</span>';
            return '<span class="badge text-bg-secondary">group</span>';
        }

        function renderQueue(data) {
            const queueTotal = document.getElementById("queueTotal");
            const queueContent = document.getElementById("queueContent");
            queueTotal.textContent = `${data.total_in_queue ?? 0} players`;

            if (!data.guilds || data.guilds.length === 0) {
                queueContent.innerHTML = '<p class="text-secondary mb-0">No guild data yet.</p>';
                return;
            }

            queueContent.innerHTML = data.guilds.map((guild) => {
                const entries = guild.entries || [];
                const rows = entries.length
                    ? entries.map((entry) => `
                        <tr>
                            <td>${escapeHtml(entry.username)}</td>
                            <td>${badgeForRole(entry.role)}</td>
                            <td>+${entry.key_min}-${entry.key_max}</td>
                        </tr>
                    `).join("")
                    : '<tr><td colspan="3" class="text-secondary">Queue empty.</td></tr>';

                return `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>${escapeHtml(guild.guild_name)}</strong>
                            <span class="badge text-bg-secondary">${guild.count} in queue</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-dark table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Role</th>
                                        <th>Range</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join("");
        }

        function renderGroups(data) {
            const groupsContent = document.getElementById("groupsContent");
            const allGroups = [];

            (data.guilds || []).forEach((guild) => {
                (guild.active_matches || []).forEach((group) => {
                    allGroups.push({
                        guild_name: guild.guild_name,
                        total_players: group.total_players,
                        entries: group.entries || [],
                    });
                });
            });

            if (!allGroups.length) {
                groupsContent.innerHTML = '<p class="text-secondary mb-0">No active groups forming right now.</p>';
                return;
            }

            groupsContent.innerHTML = allGroups.map((group) => `
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>${escapeHtml(group.guild_name)}</strong>
                        <span class="badge text-bg-info">${group.total_players}/5</span>
                    </div>
                    <ul class="list-group list-group-flush">
                        ${group.entries.map((entry) => `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>${escapeHtml(entry.username)}</span>
                                ${badgeForRole(entry.role)}
                            </li>
                        `).join("")}
                    </ul>
                </div>
            `).join("");
        }

        function renderLeaderboard(data) {
            const target = document.getElementById("leaderboardContent");
            const players = data.player_stats || data.top_players || [];

            if (!players.length) {
                target.innerHTML = '<p class="text-secondary mb-0">No leaderboard data yet.</p>';
                return;
            }

            target.innerHTML = `
                <div class="mb-2">
                    <span class="badge text-bg-secondary">Total keys: ${data.total_keys ?? 0}</span>
                </div>
                <ol class="mb-0">
                    ${players.slice(0, 10).map((player) =>
                        `<li class="mb-1">${escapeHtml(player.username)} <span class="text-secondary">(${player.key_count} keys)</span></li>`
                    ).join("")}
                </ol>
            `;
        }

        function renderCompleted(data) {
            const target = document.getElementById("completedContent");
            target.innerHTML = `
                <div class="row g-2">
                    <div class="col-12 col-md-4">
                        <div class="border rounded p-2">
                            <div class="text-secondary small">Total keys</div>
                            <div class="fs-4 fw-semibold">${data.total_keys ?? 0}</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="border rounded p-2">
                            <div class="text-secondary small">Average level</div>
                            <div class="fs-4 fw-semibold">${data.avg_key_level ?? 0}</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="border rounded p-2">
                            <div class="text-secondary small">Max level</div>
                            <div class="fs-4 fw-semibold">${data.max_key_level ?? 0}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderError(error) {
            const content = `<div class="alert alert-danger mb-0">Failed to load dashboard data: ${escapeHtml(error.message)}</div>`;
            document.getElementById("queueContent").innerHTML = content;
            document.getElementById("groupsContent").innerHTML = content;
            document.getElementById("leaderboardContent").innerHTML = content;
            document.getElementById("completedContent").innerHTML = content;
        }

        async function loadDashboard() {
            try {
                const [queue, leaderboard, completed] = await Promise.all([
                    getJson("/api/queue"),
                    getJson("/api/leaderboard?period=weekly"),
                    getJson("/api/completed?period=weekly"),
                ]);
                renderQueue(queue);
                renderGroups(queue);
                renderLeaderboard(leaderboard);
                renderCompleted(completed);
            } catch (error) {
                renderError(error);
            }
        }

        document.getElementById("refreshBtn").addEventListener("click", loadDashboard);
        loadDashboard();
        setInterval(loadDashboard, 10000);
    </script>
</body>
</html>

